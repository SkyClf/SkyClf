# Production docker-compose for end users
# Deploy with Dockge or: docker compose -f docker-compose.prod.yml up -d
#
# The trainer container is defined but not started by default.
# The Go backend starts it when user triggers training from UI.

services:
  skyclf:
    image: ghcr.io/skyclf/skyclf:latest
    container_name: skyclf
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # Persist data (images, models, labels)
      - skyclf-data:/data
      # Docker socket to start/stop trainer container
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SKYCLF_ADDR=:8080
      - SKYCLF_ALLSKY_URL=${SKYCLF_ALLSKY_URL:?Please set SKYCLF_ALLSKY_URL to your AllSky camera URL}
      - SKYCLF_POLL_INTERVAL=${SKYCLF_POLL_INTERVAL:-15s}
      - SKYCLF_DATA_DIR=/data
      - SKYCLF_LOG_LEVEL=${SKYCLF_LOG_LEVEL:-info}
      # Trainer container name (must match trainer service container_name)
      - SKYCLF_TRAINER_CONTAINER=skyclf-trainer
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      trainer:
        condition: service_started

  trainer:
    image: ghcr.io/skyclf/skyclf-trainer:latest
    container_name: skyclf-trainer
    restart: "no" # Don't auto-restart - Go backend controls it
    volumes:
      - skyclf-data:/data
    environment:
      - SKYCLF_DATA_DIR=/data
    # Default command - will be overridden by Go backend with actual params
    command: ["python", "-m", "trainer.train", "--epochs", "10"]
    profiles:
      - training # Not started by default with 'docker compose up'

volumes:
  skyclf-data:
    name: skyclf_skyclf-data
